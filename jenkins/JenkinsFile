String environment = env.environment
String gitCredentials = "Git_user"
String branch = ''
String puerto = '5000'
String repoUrl = "https://github.com/jmorenor1986/devops-example.git"
node {
    // Start Stages
	stage('Prepare environment'){
		if(environment=='acceptance'){
		branch = 'develop';
	   }
	   if(environment=='production'){
	    branch = 'main';
	   }
	   if(environment=='test'){
		branch = 'example-microservice'
	   }
	}

    stage('Clone Repo') {
        echo 'Make the output directory'
        sh 'mkdir -p build'
        echo 'Cloning files into (enviroNment: "' + environment + '" )'
       dir('build') {
          git branch: branch, credentialsId: 	gitCredentials, url: repoUrl
        }
    }

	stage('provisioning'){
         echo 'Here provisione with ansible or py script or shell scripting';
    }

	stage('Compile'){
          echo 'Mvn compile'
          sh 'mvn clean install -f build/microservice-example'
          echo 'Compile finish'

   }

   stage('Deploy'){
          echo 'Deploy into docker'
          sh 'docker build build/microservice-example -t '+branch
          echo 'Deploy success'
  }

  stage('Run'){
          echo 'Run docker'
          sh 'docker run -p '+puerto+ ':'+ puerto+ ' --name '+branch +' --detach '+branch
          echo 'Run success'
  }
}